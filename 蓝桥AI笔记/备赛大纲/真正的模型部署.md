
# 模型部署
### ONNX模型转换
```
import torch.onnx 
# 转换的onnx格式的名称，文件后缀需为.onnx
onnx_file_name = "xxxxxx.onnx"
# 我们需要转换的模型，将torch_model设置为自己的模型
model = torch_model
# 加载权重，将model.pth转换为自己的模型权重
# 如果模型的权重是使用多卡训练出来，我们需要去除权重中多的module. 具体操作可以见5.4节
model = model.load_state_dict(torch.load("model.pth"))
# 导出模型前，必须调用model.eval()或者model.train(False)
model.eval()
# dummy_input就是一个输入的实例，仅提供输入shape、type等信息 
batch_size = 1 # 随机的取值，当设置dynamic_axes后影响不大
dummy_input = torch.randn(batch_size, 1, 224, 224, requires_grad=True) 
# 这组输入对应的模型输出
output = model(dummy_input)
# 导出模型
torch.onnx.export(model,        # 模型的名称
                  dummy_input,   # 一组实例化输入
                  onnx_file_name,   # 文件保存路径/名称
                  export_params=True,        #  如果指定为True或默认, 参数也会被导出. 如果你要导出一个没训练过的就设为 False.
                  opset_version=10,          # ONNX 算子集的版本，当前已更新到15
                  do_constant_folding=True,  # 是否执行常量折叠优化
                  input_names = ['input'],   # 输入模型的张量的名称
                  output_names = ['output'], # 输出模型的张量的名称
                  # dynamic_axes将batch_size的维度指定为动态，
                  # 后续进行推理的数据可以与导出的dummy_input的batch_size不同
                  dynamic_axes={'input' : {0 : 'batch_size'},    
                                'output' : {0 : 'batch_size'}})
```

### TensorFlow Lite模型转换
#### 转换 SavedModel（推荐）

以下示例展示了如何将 [SavedModel](https://www.tensorflow.org/guide/saved_model?hl=zh-cn) 转换为 TensorFlow Lite 模型。
```
import tensorflow as tf

# Convert the model
converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir) # path to the SavedModel directory
tflite_model = converter.convert()

# Save the model.
with open('model.tflite', 'wb') as f:  
	f.write(tflite_model)
```
#### 转换 Keras 模型

以下示例展示了如何将 [Keras](https://www.tensorflow.org/guide/keras/overview?hl=zh-cn) 模型转换为 TensorFlow Lite 模型。
```
import tensorflow as tf
# Create a model using high-level tf.keras.* APIs
model = tf.keras.models.Sequential([    
tf.keras.layers.Dense(units=1, input_shape=[1]),    
tf.keras.layers.Dense(units=16, activation='relu'),    
tf.keras.layers.Dense(units=1)
	])
model.compile(optimizer='sgd', loss='mean_squared_error') # compile the model
model.fit(x=[-1, 0, 1], y=[-3, -1, 1], epochs=5) # train the model
# (to generate a SavedModel) tf.saved_model.save(model, "saved_model_keras_dir")
# Convert the model.
converter = tf.lite.TFLiteConverter.from_keras_model(model)tflite_model = converter.convert()
# Save the model.
with open('model.tflite', 'wb') as f:  
	f.write(tflite_model)
```

#### 转换具体函数

以下示例展示了如何将[个具体函数](https://www.tensorflow.org/guide/intro_to_graphs?hl=zh-cn)转换为 TensorFlow Lite 模型。

<!--stackedit_data:
eyJoaXN0b3J5IjpbLTc1MDI2MjYyLC0xOTg4NzIwODAxXX0=
-->